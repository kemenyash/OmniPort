@page "/transform"
@using OmniPort.Core.Models
@using OmniPort.UI.Presentation.Models
@using OmniPort.UI.Presentation.ViewModels
@using Microsoft.AspNetCore.Components.Forms
@inject TransformationViewModel ViewModel

<EditForm Model="@ViewModel.FormModel" OnValidSubmit="ViewModel.RunTransformation">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="space-y-6">

        <div>
            <label>Template</label>
            <InputSelect @bind-Value="@ViewModel.FormModel.SelectedMappingTemplateId"
                         class="w-full border px-3 py-2 rounded">
                <option value="0" disabled>Select template</option>
                @foreach (var t in ViewModel.JoinedTemplates)
                {
                    <option value="@t.Id">@t.FullName</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => ViewModel.FormModel.SelectedMappingTemplateId)" />
        </div>

        <div class="flex gap-4 items-center">
            <label>Import mode:</label>
            <button type="button"
                    @onclick="() => ViewModel.SetMode(UploadMode.Upload)"
                    class="@ViewModel.GetButtonClass(UploadMode.Upload)">
                Upload
            </button>
            <button type="button"
                    @onclick="() => ViewModel.SetMode(UploadMode.Url)"
                    class="@ViewModel.GetButtonClass(UploadMode.Url)">
                URL
            </button>
        </div>

        @if (ViewModel.InputMode == UploadMode.Upload)
        {
            <div class="space-y-1">
                <label>Upload File</label>
                <InputFile OnChange="ViewModel.OnFileChange"
                           class="w-full border px-3 py-2 rounded" />

                @if (!string.IsNullOrWhiteSpace(ViewModel.FormModel.UploadedFileName))
                {
                    <div class="text-sm text-gray-600">
                        Selected: @ViewModel.FormModel.UploadedFileName
                    </div>
                }
            </div>
        }

        @if (ViewModel.InputMode == UploadMode.Url)
        {
            <div>
                <label>File URL</label>
                <InputText @bind-Value="ViewModel.FormModel.FileUrl"
                           class="w-full border px-3 py-2 rounded"
                           placeholder="https://example.com/file.xlsx" />
                <ValidationMessage For="@(() => ViewModel.FormModel.FileUrl)" />
            </div>

            <div>
                <label>Check Interval (min)</label>
                <InputNumber @bind-Value="ViewModel.FormModel.IntervalMinutes"
                             class="w-32 border px-3 py-2 rounded"
                             min="1" max="1440" />
                <ValidationMessage For="@(() => ViewModel.FormModel.IntervalMinutes)" />
            </div>
        }

        <div class="flex items-center gap-3">
            <button type="submit"
                    class="bg-green-600 text-white px-4 py-2 rounded disabled:opacity-50"
                    disabled="@(!ViewModel.CanRun)">
                Run Transformation
            </button>

            @if (ViewModel.InputMode == UploadMode.Url)
            {
                <button type="button"
                        class="bg-indigo-600 text-white px-4 py-2 rounded disabled:opacity-50"
                        disabled="@(!ViewModel.CanAddToWatchlist)"
                        @onclick="ViewModel.AddToWatchlistFromForm">
                    Add to Watchlist
                </button>
            }
        </div>
    </div>
</EditForm>

<hr class="my-10" />

@if (ViewModel.InputMode == UploadMode.Url && ViewModel.WatchedUrls.Any())
{
    <h2 class="text-lg font-semibold mb-2">Watched URLs</h2>
    <table class="w-full table-auto border border-gray-300">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">URL</th>
                <th class="px-4 py-2 text-left">Template</th>
                <th class="px-4 py-2 text-left">Interval (min)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var w in ViewModel.WatchedUrls)
            {
                <tr>
                    <td class="border px-4 py-2">@w.Url</td>
                    <td class="border px-4 py-2">@w.MappingTemplateName</td>
                    <td class="border px-4 py-2">@w.IntervalMinutes</td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ViewModel.InputMode == UploadMode.Url && ViewModel.UrlConversions.Any())
{
    <h2 class="text-lg font-semibold mb-2">URL Conversion History</h2>
    <table class="w-full table-auto border border-gray-300">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">Input URL</th>
                <th class="px-4 py-2 text-left">Converted At</th>
                <th class="px-4 py-2 text-left">Template</th>
                <th class="px-4 py-2 text-left">Output</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in ViewModel.UrlConversions)
            {
                <tr>
                    <td class="border px-4 py-2">@u.InputUrl</td>
                    <td class="border px-4 py-2">@u.ConvertedAt.ToLocalTime()</td>
                    <td class="border px-4 py-2">@u.MappingTemplateName</td>
                    <td class="border px-4 py-2">
                        <a href="@u.OutputLink" target="_blank" class="text-blue-600 underline">View</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (ViewModel.InputMode == UploadMode.Upload && ViewModel.FileConversions.Any())
{
    <h2 class="text-lg font-semibold mb-2">File Conversion History</h2>
    <table class="w-full table-auto border border-gray-300">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-4 py-2 text-left">File Name</th>
                <th class="px-4 py-2 text-left">Converted At</th>
                <th class="px-4 py-2 text-left">Template</th>
                <th class="px-4 py-2 text-left">Output</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in ViewModel.FileConversions)
            {
                <tr>
                    <td class="border px-4 py-2">@f.FileName</td>
                    <td class="border px-4 py-2">@f.ConvertedAt.ToLocalTime()</td>
                    <td class="border px-4 py-2">@f.MappingTemplateName</td>
                    <td class="border px-4 py-2">
                        <a href="@f.OutputLink" target="_blank" class="text-blue-600 underline">View</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
